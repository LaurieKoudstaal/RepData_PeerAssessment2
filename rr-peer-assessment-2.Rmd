---
title: 'Reproducible Research: Peer Assessment 2'
output: 
        html_document: 
                keep_md: true
---

# Most Impactful Weather Events

## Synopsis
In this report we aim to determine which weather events int he US are most
impactful on both life and limb, as well as economically. To investigate this,
we obtained data from the US National Weather Service for the years 1950 to 
2011.

## Requirements
```{r requirements}
require(dplyr)
require(tidyr)
require(ggplot2)
```

## Loading and Processing the Raw Data
We obtained the data from the [National Weather Service](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2)
on 19 August 2015.
```{r fetching data}
BZ_FILE_NAME <- 'StormData.csv.bz2'

if (!file.exists(BZ_FILE_NAME)) {
        download.file(
                url = 'https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2',
                destfile = BZ_FILE_NAME,
                method = 'curl'
        )
}
```


### Load the data

```{r loading data, cache=TRUE}
bz_file <- bzfile(BZ_FILE_NAME)
storm_data <- tbl_df(read.csv(bz_file))

clean_data <- storm_data %>% select(event_type = EVTYPE, 
                                    fatalities = FATALITIES,
                                    injuries = INJURIES
                                    )

clean_data <- gather(clean_data, health_effect, health_effect_count, fatalities, injuries)

by_event_type <- group_by(clean_data, event_type, health_effect) %>%
        summarise(health_effect_count = sum(health_effect_count))
```


```{r}
health_effect_total <- count(by_event_type, health_effect)

top_event_type <- by_event_type %>%
        group_by(health_effect) %>%
        filter(rank(health_effect_count, ties.method='first') > (health_effect_total$n[1] - 10))
```

```{r}
ggplot(top_event_type) + 
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        aes(x = event_type, y = health_effect_count, fill = health_effect) +
        geom_bar(stat = "identity", position = "dodge") +
        geom_text(aes(label = health_effect_count), size = 4, vjust = 0) +
        facet_grid(health_effect ~ ., scale = "free_y") +
        xlab("Event Type") +
        ylab("Number of Health Effects") +
        ggtitle("Health Effects")
```